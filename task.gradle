class BuildTimeListener implements TaskExecutionListener, BuildListener {

    //用来记录 task 的执行时长信息
    Map<String, TaskTimeInfo> taskTimeMap = new HashMap<>()

    @Override
    void settingsEvaluated(Settings settings) {

    }

    @Override
    void projectsLoaded(Gradle gradle) {

    }

    @Override
    void projectsEvaluated(Gradle gradle) {

    }

    @Override
    void buildFinished(BuildResult buildResult) {
        println "-----------------GouAPM----------------------"
        println "---------------------------------------"
        println "build finished, now println all task execution time:"
        List<TaskTimeInfo> taskTimeInfos = new ArrayList<>(taskTimeMap.values())
        Collections.sort(taskTimeInfos, new Comparator<TaskTimeInfo>() {
            @Override
            int compare(TaskTimeInfo t0, TaskTimeInfo t1) {
                return t0.start < t1.start ? -1 : (t0.start > t1.start ? 1 : 0)
            }
        })
        taskTimeInfos.each { info ->
            {
                if (info.total > 10L && info.path.matches(".*Asm.*")) {
                    println "${info.path}:[${info.total}ms]"
                }
            }
        }
        println "---------------------------------------"
        println "---------------------------------------"
    }

    @Override
    void beforeExecute(Task task) {
        //task开始执行之前搜集task的信息
        TaskTimeInfo timeInfo = new TaskTimeInfo()
        timeInfo.start = System.currentTimeMillis()
        timeInfo.path = task.getPath()
        taskTimeMap.put(task.getPath(), timeInfo)
    }

    @Override
    void afterExecute(Task task, TaskState taskState) {
        //task执行完之后，记录结束时的时间
        TaskTimeInfo timeInfo = taskTimeMap.get(task.getPath())
        timeInfo.end = System.currentTimeMillis()
        //计算该 task 的执行时长
        timeInfo.total = timeInfo.end - timeInfo.start
    }


}

class TaskTimeInfo {
    //task执行总时长
    public long total
    public String path
    public long start
    public long end
}

project.gradle.addListener(new BuildTimeListener())